<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"willzhuang.github.io","root":"/","images":"/images","scheme":"Muse","version":"8.3.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>
<meta property="og:type" content="website">
<meta property="og:title" content="Zhuang&#39;s Diary">
<meta property="og:url" content="https://willzhuang.github.io/index.html">
<meta property="og:site_name" content="Zhuang&#39;s Diary">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Weiming Zhuang">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://willzhuang.github.io/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>
<title>Zhuang's Diary</title>
  




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Zhuang's Diary</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">日拱一卒，功不唐捐 // never too late</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Weiming Zhuang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">181</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">82</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://willzhuang.github.io/2022/04/18/Open%20source%20ecommerce%20platform%20for%20multi-vendor%20marketplaces/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Weiming Zhuang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhuang's Diary">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/04/18/Open%20source%20ecommerce%20platform%20for%20multi-vendor%20marketplaces/" class="post-title-link" itemprop="url">Open source ecommerce platform for multi-vendor marketplaces</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-04-18 17:18:00" itemprop="dateCreated datePublished" datetime="2022-04-18T17:18:00+08:00">2022-04-18</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2022-04-20 22:39:01" itemprop="dateModified" datetime="2022-04-20T22:39:01+08:00">2022-04-20</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>I tried here <a target="_blank" rel="noopener" href="https://github.com/adrien2p/medusa-extender#marketplace-tutorial">https://github.com/adrien2p/medusa-extender#marketplace-tutorial</a>, the same as <a target="_blank" rel="noopener" href="https://github.com/shahednasser/medusa-marketplace">https://github.com/shahednasser/medusa-marketplace</a>, but fail to “npm start”.</p>
<p>But we can run it buy code update directly step by step — <a target="_blank" rel="noopener" href="https://dev.to/medusajs/create-an-open-source-commerce-marketplace-part-1-3m5k">https://dev.to/medusajs/create-an-open-source-commerce-marketplace-part-1-3m5k</a>.</p>
<p>====================================== guide detail ======================================</p>
<p><a target="_blank" rel="noopener" href="https://www.medusajs.com/">Medusa</a> is an open source headless commerce platform that allows you to create your own store in a matter of minutes. Part of what makes Medusa a good choice for your ecommerce store is its extensibility. <strong>Now, it is also possible to create multi-vendor marketplaces using Medusa</strong>.</p>
<p>To make things easier for our open source community, <a target="_blank" rel="noopener" href="https://github.com/adrien2p">Adrien de Peretti</a>, one of our amazing contributors, created a Medusa module that allows you to extend anything and everything you want.</p>
<blockquote>
<p>“I’ve been looking for an e-commerce solution that could provide me with some core features while being fully customisable… After some research, where I found that none of the present solutions could provide what I needed, I chose Medusa as it provided me with many of the needed features while being easy to extend. I ended up loving the community atmosphere, especially the proximity with the team, and have been helping those in the community looking for a similar fully-customisable solution by sharing a part of my private project. This is how the medusa-extender was born.” — Adrien de Peretti</p>
</blockquote>
<p>In this tutorial, you’ll learn how to install and set up the Medusa Extender module on your Medusa server. You’ll then learn how to use its customization abilities to create a marketplace in your store! The marketplace will have multiple stores or vendors, and each of these stores will be able to add its own products. This tutorial will be the first part of a series that will explore all aspects of creating a marketplace.</p>
<h2 id="What-is-Medusa-Extender"><a href="#What-is-Medusa-Extender" class="headerlink" title="What is Medusa Extender"></a>What is Medusa Extender</h2><p><a target="_blank" rel="noopener" href="https://github.com/adrien2p/medusa-extender">Medusa Extender</a> is an NPM package that you can add to your Medusa store to extend or customize its functionalities. The scope of its customization entails Entities, Repositories, Services, and more.</p>
<p>The Medusa Extender has many use cases aside the marketplace functionality. It can be used in many other use cases, such as adding custom fields, listening to events to perform certain actions like sending emails, customizing Medusa’s validation of request parameters, and more.</p>
<h2 id="What-You’ll-Be-Creating"><a href="#What-You’ll-Be-Creating" class="headerlink" title="What You’ll Be Creating"></a>What You’ll Be Creating</h2><p>In this article and the following parts of this series, you’ll learn how to create a marketplace using Medusa and Medusa Extender. A marketplace is an online store that allows multiple vendors to add their products and sell them.</p>
<p>A marketplace has a lot of features, including managing a vendor’s own orders and settings. This part of the tutorial will only showcase how to create stores for each user and attach the products they create to that store.</p>
<h2 id="Code-for-This-Tutorial"><a href="#Code-for-This-Tutorial" class="headerlink" title="Code for This Tutorial"></a>Code for This Tutorial</h2><p>If you want to follow along you can find the code for this tutorial in <a target="_blank" rel="noopener" href="https://github.com/shahednasser/medusa-marketplace-tutorial">this repository</a>.</p>
<p>Alternatively, if you want to install the marketplace into your existing Medusa store, you can install the <a target="_blank" rel="noopener" href="https://github.com/shahednasser/medusa-marketplace">Medusa Marketplace plugin</a>. This plugin is created with the code from this tutorial and will be updated with every new part of this series released.</p>
<h2 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h2><p>Before you follow along with this tutorial, make sure you have:</p>
<ol>
<li>A Medusa server instance was installed. You can follow along with our easy <a target="_blank" rel="noopener" href="https://docs.medusajs.com/quickstart/quick-start">quickstart guide</a> to learn how you can do that.</li>
<li><a target="_blank" rel="noopener" href="https://www.postgresql.org/download/">PostgreSQL</a> installed and your Medusa server connected to it.</li>
<li><a target="_blank" rel="noopener" href="https://redis.io/download">Redis</a> installed and your Medusa server connected to it.</li>
</ol>
<h2 id="Building-the-Marketplace"><a href="#Building-the-Marketplace" class="headerlink" title="Building the Marketplace"></a>Building the Marketplace</h2><h3 id="Project-Setup"><a href="#Project-Setup" class="headerlink" title="Project Setup"></a>Project Setup</h3><p>In the directory that holds your Medusa server, start by installing Medusa Extender using NPM:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i medusa-extender</span><br></pre></td></tr></table></figure>



<p>It’s recommended that you use TypeScript in your project to get the full benefits of Medusa-Extender. To do that, create the file <code>tsconfig.json</code> in the root of the Medusa project with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;compilerOptions&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;module&quot;</span>: <span class="string">&quot;CommonJS&quot;</span>,</span><br><span class="line">    <span class="string">&quot;declaration&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;emitDecoratorMetadata&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;experimentalDecorators&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;allowSyntheticDefaultImports&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;moduleResolution&quot;</span>: <span class="string">&quot;node&quot;</span>,</span><br><span class="line">    <span class="string">&quot;target&quot;</span>: <span class="string">&quot;es2017&quot;</span>,</span><br><span class="line">    <span class="string">&quot;sourceMap&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;skipLibCheck&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;allowJs&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;outDir&quot;</span>: <span class="string">&quot;dist&quot;</span>,</span><br><span class="line">    <span class="string">&quot;rootDir&quot;</span>: <span class="string">&quot;.&quot;</span>,</span><br><span class="line">    <span class="string">&quot;esModuleInterop&quot;</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;include&quot;</span>: [<span class="string">&quot;src&quot;</span>, <span class="string">&quot;medusa-config.js&quot;</span>],</span><br><span class="line">  <span class="string">&quot;exclude&quot;</span>: [<span class="string">&quot;dist&quot;</span>, <span class="string">&quot;node_modules&quot;</span>, <span class="string">&quot;**/*.spec.ts&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>Next, update the <code>scripts</code> key in <code>package.json</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;seed&quot;</span>: <span class="string">&quot;medusa seed -f ./data/seed.json&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build&quot;</span>: <span class="string">&quot;rm -rf dist &amp;&amp; tsc&quot;</span>,</span><br><span class="line">    <span class="string">&quot;start&quot;</span>: <span class="string">&quot;npm run build &amp;&amp; node dist/src/main.js&quot;</span>,</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>



<p>These scripts will ensure that your TypeScript files will be transpiled before Medusa is run.</p>
<p>Then, create the file <code>main.ts</code> in the directory <code>src</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Medusa &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> expressInstance = express();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> <span class="keyword">new</span> Medusa(__dirname + <span class="string">&#x27;/../&#x27;</span>, expressInstance).load([]);</span><br><span class="line"></span><br><span class="line">    expressInstance.listen(<span class="number">9000</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.info(<span class="string">&#x27;Server successfully started on port 9000&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bootstrap();</span><br></pre></td></tr></table></figure>



<p>This file will make sure to load all the customizations you’ll add next when you run your Medusa server.</p>
<p>Now, Medusa Extender is fully integrated into your Medusa instance and you can start building the Marketplace.</p>
<h3 id="Customize-the-Store-Entity"><a href="#Customize-the-Store-Entity" class="headerlink" title="Customize the Store Entity"></a>Customize the Store Entity</h3><p>You’ll start by customizing the Store entity. You’ll need to use it later on to add relations between the store entity and the users and products entities.</p>
<p>By convention, customizations using Medusa Extender are organized in a module-like structure. However, this is completely optional.</p>
<p>In the <code>src</code> directory, create the directory <code>modules</code> in which you’ll store all the customizations in.</p>
<p>Then, create the directory <code>store</code> inside the <code>modules</code> directory. The <code>store</code> directory will hold all customizations related to the Store.</p>
<p><strong>Create a Store Entity</strong></p>
<p>Create the file <code>src/modules/store/entities/store.entity.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Store <span class="keyword">as</span> MedusaStore &#125; <span class="keyword">from</span> <span class="string">&#x27;@medusajs/medusa/dist&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Entity, JoinColumn, OneToMany &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Entity <span class="keyword">as</span> MedusaEntity &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@MedusaEntity(&#123; <span class="attr">override</span>: MedusaStore &#125;)</span><br><span class="line">@Entity()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Store</span> <span class="keyword">extends</span> <span class="title">MedusaStore</span> </span>&#123;</span><br><span class="line">    <span class="comment">//TODO add relations</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>This uses the decorator <code>@Entity</code> from <code>medusa-extender</code> to customize Medusa’s <code>Store</code> entity. You create a <code>Store</code> class that extends Medusa’s Store entity (imported as <code>MedusaStore</code> ).</p>
<p>You’ll, later on, edit this entity to add the relations between the store and users and products.</p>
<p><strong>Create a Store Repository</strong></p>
<p>Next, you need to override Medusa’s <code>StoreRepository</code>. This repository will return Medusa’s <code>Store</code> entity. So, you need to override it to make sure it returns your <code>Store</code> entity that you just created.</p>
<p>Create the file <code>src/modules/store/repositories/store.repository.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; EntityRepository &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; StoreRepository <span class="keyword">as</span> MedusaStoreRepository &#125; <span class="keyword">from</span> <span class="string">&#x27;@medusajs/medusa/dist/repositories/store&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Repository <span class="keyword">as</span> MedusaRepository, Utils &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Store &#125; <span class="keyword">from</span> <span class="string">&#x27;../entities/store.entity&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@MedusaRepository(&#123; <span class="attr">override</span>: MedusaStoreRepository &#125;)</span><br><span class="line">@EntityRepository(Store)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">StoreRepository</span> <span class="keyword">extends</span> <span class="title">Utils</span>.<span class="title">repositoryMixin</span>&lt;<span class="title">Store</span>, <span class="title">MedusaStoreRepository</span>&gt;(<span class="title">MedusaStoreRepository</span>) </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>Create the Store Module</strong></p>
<p>For now, these are the only files you’ll add for the store. You can create the Store module using these files.</p>
<p>Create the file <code>src/modules/store/store.module.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Store &#125; <span class="keyword">from</span> <span class="string">&#x27;./entities/store.entity&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> StoreRepository <span class="keyword">from</span> <span class="string">&#x27;./repositories/store.repository&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@Module(&#123;</span><br><span class="line">    imports: [Store, StoreRepository],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">StoreModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>



<p>This uses the <code>@Module</code> decorator from <code>medusa-extender</code> and imports the 2 classes you created.</p>
<p>The last thing left is to import this module and use it with Medusa. In <code>src/main.ts</code> import <code>StoreModule</code> at the beginning of the file:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; StoreModule &#125; <span class="keyword">from</span> <span class="string">&#x27;./modules/store/store.module&#x27;</span>;</span><br></pre></td></tr></table></figure>



<p>Then, add the <code>StoreModule</code> in the array passed as a parameter to <code>Medusa.load</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="keyword">new</span> Medusa(__dirname + <span class="string">&#x27;/../&#x27;</span>, expressInstance).load([</span><br><span class="line">    StoreModule</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>



<p>This is all that you’ll do for now in the Store module. In the next sections, you’ll be adding more classes to it as necessary.</p>
<h3 id="Customize-the-User-Entity"><a href="#Customize-the-User-Entity" class="headerlink" title="Customize the User Entity"></a>Customize the User Entity</h3><p>In this section, you’ll customize the user entity mainly to link the user to a store.</p>
<p><strong>Create the User Entity</strong></p>
<p>Create the directory <code>user</code> inside the <code>modules</code> directory and create the file <code>src/modules/user/entities/user.entity.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; User <span class="keyword">as</span> MedusaUser &#125; <span class="keyword">from</span> <span class="string">&#x27;@medusajs/medusa/dist&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Column, Entity, Index, JoinColumn, ManyToOne &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Entity <span class="keyword">as</span> MedusaEntity &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Store &#125; <span class="keyword">from</span> <span class="string">&#x27;../../store/entities/store.entity&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@MedusaEntity(&#123; <span class="attr">override</span>: MedusaUser &#125;)</span><br><span class="line">@Entity()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">MedusaUser</span> </span>&#123;</span><br><span class="line">    @Index()</span><br><span class="line">    @Column(&#123; <span class="attr">nullable</span>: <span class="literal">false</span> &#125;)</span><br><span class="line">    store_id: string;</span><br><span class="line"></span><br><span class="line">    @ManyToOne(<span class="function">() =&gt;</span> Store, <span class="function">(<span class="params">store</span>) =&gt;</span> store.members)</span><br><span class="line">    @JoinColumn(&#123; <span class="attr">name</span>: <span class="string">&#x27;store_id&#x27;</span> &#125;)</span><br><span class="line">    store: Store;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>This class will add an additional column <code>store_id</code> of type string and will add a relation to the <code>Store</code> entity.</p>
<p>To add the new column to the <code>user</code> table in the database, you need to create a Migration file. Create the file <code>src/modules/user/migrations/user.migration.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Migration &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; MigrationInterface, QueryRunner &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@Migration()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">addStoreIdToUser1644946220401</span> <span class="title">implements</span> <span class="title">MigrationInterface</span> </span>&#123;</span><br><span class="line">    name = <span class="string">&#x27;addStoreIdToUser1644946220401&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">async</span> up(queryRunner: QueryRunner): <span class="built_in">Promise</span>&lt;<span class="keyword">void</span>&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> query = <span class="string">`ALTER TABLE public.&quot;user&quot; ADD COLUMN IF NOT EXISTS &quot;store_id&quot; text;`</span>;</span><br><span class="line">      <span class="keyword">await</span> queryRunner.query(query);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">async</span> down(queryRunner: QueryRunner): <span class="built_in">Promise</span>&lt;<span class="keyword">void</span>&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> query = <span class="string">`ALTER TABLE public.&quot;user&quot; DROP COLUMN &quot;store_id&quot;;`</span>;</span><br><span class="line">      <span class="keyword">await</span> queryRunner.query(query);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>The migration is created using the <code>@Migration</code> decorator from <code>medusa-extender</code>. Notice that the migration name should end with a JavaScript timestamp based on <code>typeorm</code>‘s conventions.</p>
<p>The <code>up</code> method is run if the migration hasn’t been run before. It will add the column <code>store_id</code> to the table <code>user</code> if it doesn’t exist.</p>
<p>You’ll also need to add the relation between the Store and the User entities in <code>src/modules/store/entities/store.entity.ts</code> . Replace the <code>//TODO</code> with the following:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@OneToMany(<span class="function">() =&gt;</span> User, <span class="function">(<span class="params">user</span>) =&gt;</span> user.store)</span><br><span class="line">@JoinColumn(&#123; <span class="attr">name</span>: <span class="string">&#x27;id&#x27;</span>, <span class="attr">referencedColumnName</span>: <span class="string">&#x27;store_id&#x27;</span> &#125;)</span><br><span class="line">members: User[];</span><br></pre></td></tr></table></figure>



<p>Make sure to import the <code>User</code> entity at the beginning of the file:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; User &#125; <span class="keyword">from</span> <span class="string">&#x27;../../user/entities/user.entity&#x27;</span>;</span><br></pre></td></tr></table></figure>



<p><strong>Create the User Repository</strong></p>
<p>Next, you need to override Medusa’s <code>UserRepository</code>. Create the file <code>src/modules/user/repositories/user.repository.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; UserRepository <span class="keyword">as</span> MedusaUserRepository &#125; <span class="keyword">from</span> <span class="string">&quot;@medusajs/medusa/dist/repositories/user&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Repository <span class="keyword">as</span> MedusaRepository, Utils &#125; <span class="keyword">from</span> <span class="string">&quot;medusa-extender&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; EntityRepository &#125; <span class="keyword">from</span> <span class="string">&quot;typeorm&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; User &#125; <span class="keyword">from</span> <span class="string">&quot;../entities/user.entity&quot;</span>;</span><br><span class="line"></span><br><span class="line">@MedusaRepository(&#123; <span class="attr">override</span>: MedusaUserRepository &#125;)</span><br><span class="line">@EntityRepository(User)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRepository</span> <span class="keyword">extends</span> <span class="title">Utils</span>.<span class="title">repositoryMixin</span>&lt;<span class="title">User</span>, <span class="title">MedusaUserRepository</span>&gt;(<span class="title">MedusaUserRepository</span>) </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>Create the User Service</strong></p>
<p>Next, you need to override Medusa’s <code>UserService</code> class. Create the file <code>src/modules/user/services/user.service.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Service &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; EntityManager &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> EventBusService <span class="keyword">from</span> <span class="string">&#x27;@medusajs/medusa/dist/services/event-bus&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; FindConfig &#125; <span class="keyword">from</span> <span class="string">&#x27;@medusajs/medusa/dist/types/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UserService <span class="keyword">as</span> MedusaUserService &#125; <span class="keyword">from</span> <span class="string">&#x27;@medusajs/medusa/dist/services&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; User &#125; <span class="keyword">from</span> <span class="string">&#x27;../entities/user.entity&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> UserRepository <span class="keyword">from</span> <span class="string">&#x27;../repositories/user.repository&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; MedusaError &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-core-utils&#x27;</span>;</span><br><span class="line"></span><br><span class="line">type ConstructorParams = &#123;</span><br><span class="line">    manager: EntityManager;</span><br><span class="line">    userRepository: <span class="keyword">typeof</span> UserRepository;</span><br><span class="line">    eventBusService: EventBusService;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">@Service(&#123; <span class="attr">override</span>: MedusaUserService &#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> <span class="keyword">extends</span> <span class="title">MedusaUserService</span> </span>&#123;</span><br><span class="line">    private readonly manager: EntityManager;</span><br><span class="line">    private readonly userRepository: <span class="keyword">typeof</span> UserRepository;</span><br><span class="line">    private readonly eventBus: EventBusService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">private readonly container: ConstructorParams</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(container);</span><br><span class="line">        <span class="built_in">this</span>.manager = container.manager;</span><br><span class="line">        <span class="built_in">this</span>.userRepository = container.userRepository;</span><br><span class="line">        <span class="built_in">this</span>.eventBus = container.eventBusService;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">async</span> retrieve(userId: string, config?: FindConfig&lt;User&gt;): <span class="built_in">Promise</span>&lt;User&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> userRepo = <span class="built_in">this</span>.manager.getCustomRepository(<span class="built_in">this</span>.userRepository);</span><br><span class="line">        <span class="keyword">const</span> validatedId = <span class="built_in">this</span>.validateId_(userId);</span><br><span class="line">        <span class="keyword">const</span> query = <span class="built_in">this</span>.buildQuery_(&#123; <span class="attr">id</span>: validatedId &#125;, config);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> user = <span class="keyword">await</span> userRepo.findOne(query);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> MedusaError(MedusaError.Types.NOT_FOUND, <span class="string">`User with id: <span class="subst">$&#123;userId&#125;</span> was not found`</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> user <span class="keyword">as</span> User;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>This uses the <code>@Service</code> decorator from <code>medusa-extender</code> to override Medusa’s <code>UserService</code>. The class you create to override it will extend <code>UserService</code>.</p>
<p>This new class overrides the <code>retrieve</code> method to ensure that the user returned is the new User entity class you created earlier.</p>
<p><strong>Create a User Middleware</strong></p>
<p>The <code>loggedInUser</code> is not available natively in Medusa. You’ll need to create a Middleware that, when a request is authenticated, registers the logged-in User within the scope.</p>
<p>Create the file <code>src/modules/user/middlewares/loggedInUser.middleware.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; MedusaAuthenticatedRequest, MedusaMiddleware, Middleware &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; NextFunction, Response &#125; <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> UserService <span class="keyword">from</span> <span class="string">&#x27;../../user/services/user.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@Middleware(&#123; <span class="attr">requireAuth</span>: <span class="literal">true</span>, <span class="attr">routes</span>: [&#123; <span class="attr">method</span>: <span class="string">&quot;all&quot;</span>, <span class="attr">path</span>: <span class="string">&#x27;*&#x27;</span> &#125;] &#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">LoggedInUserMiddleware</span> <span class="title">implements</span> <span class="title">MedusaMiddleware</span> </span>&#123;</span><br><span class="line">    public <span class="keyword">async</span> consume(req: MedusaAuthenticatedRequest, <span class="attr">res</span>: Response, <span class="attr">next</span>: NextFunction): <span class="built_in">Promise</span>&lt;<span class="keyword">void</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (req.user &amp;&amp; req.user.userId) &#123;</span><br><span class="line">            <span class="keyword">const</span> userService = req.scope.resolve(<span class="string">&#x27;userService&#x27;</span>) <span class="keyword">as</span> UserService;</span><br><span class="line">            <span class="keyword">const</span> loggedInUser = <span class="keyword">await</span> userService.retrieve(req.user.userId, &#123;</span><br><span class="line">                select: [<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;store_id&#x27;</span>],</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            req.scope.register(&#123;</span><br><span class="line">                loggedInUser: &#123;</span><br><span class="line">                    resolve: <span class="function">() =&gt;</span> loggedInUser,</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        next();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>You can use the <code>@Middleware</code> decorator from <code>medusa-extender</code> to create a Middleware that runs on specific requests. This Middleware is run when the request is received from an authenticated user, and it runs for all paths (notice the use of <code>path: &#39;*&#39;</code> ) and for all types of requests (notice the use of <code>method: &quot;all&quot;</code>).</p>
<p>Inside the middleware, you retrieve the current user ID from the request, then retrieve the user model and register it in the scope so that it can be accessed from services.</p>
<blockquote>
<p>This approach is simplified for the purpose of this tutorial. However, it makes more sense to include this middleware in a separate <code>auth</code> module. Whether you include this middleware in the <code>user</code> module or the <code>auth</code> middleware will not affect its functionality.</p>
</blockquote>
<p><strong>Create a Store Service to Handle User Insert Events</strong></p>
<p>You need to ensure that when a user is created, a store is associated with it. You can do that by listening to the User-created event and creating a new store for that user. You’ll add this event handler in a <code>StoreService</code>.</p>
<p>Create the file <code>src/modules/store/services/store.service.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; StoreService <span class="keyword">as</span> MedusaStoreService &#125; <span class="keyword">from</span> <span class="string">&#x27;@medusajs/medusa/dist/services&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; EntityManager &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CurrencyRepository &#125; <span class="keyword">from</span> <span class="string">&#x27;@medusajs/medusa/dist/repositories/currency&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Store &#125; <span class="keyword">from</span> <span class="string">&#x27;../entities/store.entity&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; EntityEventType, Service, MedusaEventHandlerParams, OnMedusaEntityEvent &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; User &#125; <span class="keyword">from</span> <span class="string">&#x27;../../user/entities/user.entity&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> EventBusService <span class="keyword">from</span> <span class="string">&#x27;@medusajs/medusa/dist/services/event-bus&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> StoreRepository <span class="keyword">from</span> <span class="string">&#x27;../repositories/store.repository&#x27;</span>;</span><br><span class="line"></span><br><span class="line">interface ConstructorParams &#123;</span><br><span class="line">    loggedInUser: User;</span><br><span class="line">    manager: EntityManager;</span><br><span class="line">    storeRepository: <span class="keyword">typeof</span> StoreRepository;</span><br><span class="line">    currencyRepository: <span class="keyword">typeof</span> CurrencyRepository;</span><br><span class="line">    eventBusService: EventBusService;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Service(&#123; <span class="attr">override</span>: MedusaStoreService, <span class="attr">scope</span>: <span class="string">&#x27;SCOPED&#x27;</span> &#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">StoreService</span> <span class="keyword">extends</span> <span class="title">MedusaStoreService</span> </span>&#123;</span><br><span class="line">    private readonly manager: EntityManager;</span><br><span class="line">    private readonly storeRepository: <span class="keyword">typeof</span> StoreRepository;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">private readonly container: ConstructorParams</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(container);</span><br><span class="line">        <span class="built_in">this</span>.manager = container.manager;</span><br><span class="line">        <span class="built_in">this</span>.storeRepository = container.storeRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    withTransaction(transactionManager: EntityManager): StoreService &#123;</span><br><span class="line">        <span class="keyword">if</span> (!transactionManager) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> cloned = <span class="keyword">new</span> StoreService(&#123;</span><br><span class="line">            ...this.container,</span><br><span class="line">            manager: transactionManager,</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        cloned.transactionManager_ = transactionManager;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> cloned;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @OnMedusaEntityEvent.Before.Insert(User, &#123; <span class="attr">async</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">    public <span class="keyword">async</span> createStoreForNewUser(</span><br><span class="line">        params: MedusaEventHandlerParams&lt;User, <span class="string">&#x27;Insert&#x27;</span>&gt;</span><br><span class="line">    ): <span class="built_in">Promise</span>&lt;EntityEventType&lt;User, <span class="string">&#x27;Insert&#x27;</span>&gt;&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; event &#125; = params;</span><br><span class="line">        <span class="keyword">const</span> createdStore = <span class="keyword">await</span> <span class="built_in">this</span>.withTransaction(event.manager).createForUser(event.entity);</span><br><span class="line">        <span class="keyword">if</span> (!!createdStore) &#123;</span><br><span class="line">            event.entity.store_id = createdStore.id;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> event;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">async</span> createForUser(user: User): <span class="built_in">Promise</span>&lt;Store | <span class="keyword">void</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (user.store_id) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> storeRepo = <span class="built_in">this</span>.manager.getCustomRepository(<span class="built_in">this</span>.storeRepository);</span><br><span class="line">        <span class="keyword">const</span> store = storeRepo.create() <span class="keyword">as</span> Store;</span><br><span class="line">        <span class="keyword">return</span> storeRepo.save(store);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">async</span> <span class="function"><span class="title">retrieve</span>(<span class="params">relations: string[] = []</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.container.loggedInUser) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>.retrieve(relations);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> storeRepo = <span class="built_in">this</span>.manager.getCustomRepository(<span class="built_in">this</span>.storeRepository);</span><br><span class="line">        <span class="keyword">const</span> store = <span class="keyword">await</span> storeRepo.findOne(&#123;</span><br><span class="line">            relations,</span><br><span class="line">            join: &#123; <span class="attr">alias</span>: <span class="string">&#x27;store&#x27;</span>, <span class="attr">innerJoin</span>: &#123; <span class="attr">members</span>: <span class="string">&#x27;store.members&#x27;</span> &#125; &#125;,</span><br><span class="line">            where: <span class="function">(<span class="params">qb</span>) =&gt;</span> &#123;</span><br><span class="line">                qb.where(<span class="string">&#x27;members.id = :memberId&#x27;</span>, &#123; <span class="attr">memberId</span>: <span class="built_in">this</span>.container.loggedInUser.id &#125;);</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!store) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;Unable to find the user store&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> store;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>@OnMedusaEntityEvent.Before.Insert</code> is used to add a listener to an insert event on an entity, which in this case is the <code>User</code> entity. Inside the listener, you create the user using the <code>createForUser</code> method. This method just uses the <code>StoreRepository</code> to create a store.</p>
<p>You also add a helper event <code>retrieve</code> to retrieve the store that belongs to the currently logged-in user.</p>
<p>Notice the use of <code>scope: &#39;SCOPED&#39;</code> in the <code>@Service</code> decorator. This will allow you to access the logged in user you registered earlier in the scope.</p>
<p>You’ll need to import this new class into the <code>StoreModule</code>. In <code>src/modules/store/store.module.ts</code> add the following import at the beginning:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> StoreService <span class="keyword">from</span> <span class="string">&#x27;./services/store.service&#x27;</span>;</span><br></pre></td></tr></table></figure>



<p>Then, add the <code>StoreService</code> to the <code>imports</code> array passed to <code>@Module</code> :</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">imports: [Store, StoreRepository, StoreService],</span><br></pre></td></tr></table></figure>



<p><strong>Create a User Subscriber</strong></p>
<p>For the event listener to work, you need to first emit this event in a subscriber. The event will be emitted before a <code>User</code> is inserted. Create the file <code>src/modules/user/subscribers/user.subscriber.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Connection, EntitySubscriberInterface, EventSubscriber, InsertEvent &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; eventEmitter, Utils <span class="keyword">as</span> MedusaUtils, OnMedusaEntityEvent &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; User &#125; <span class="keyword">from</span> <span class="string">&#x27;../entities/user.entity&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@EventSubscriber()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">UserSubscriber</span> <span class="title">implements</span> <span class="title">EntitySubscriberInterface</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> attachTo(connection: Connection): <span class="keyword">void</span> &#123;</span><br><span class="line">        MedusaUtils.attachOrReplaceEntitySubscriber(connection, UserSubscriber);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public listenTo(): <span class="keyword">typeof</span> User &#123;</span><br><span class="line">        <span class="keyword">return</span> User;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">async</span> beforeInsert(event: InsertEvent&lt;User&gt;): <span class="built_in">Promise</span>&lt;<span class="keyword">void</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> eventEmitter.emitAsync(OnMedusaEntityEvent.Before.InsertEvent(User), &#123;</span><br><span class="line">            event,</span><br><span class="line">            transactionalEntityManager: event.manager,</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>This will create a subscriber using the <code>EventSubscriber</code> decorator from <code>typeorm</code>. Then, before a user is inserted the <code>OnMedusaEntityEvent.Before.InsertEvent</code> event from <code>medusa-extender</code> is emitted, which will trigger creating the store.</p>
<p>To register the subscriber, you need to create a middleware that registers it. Create the file <code>src/modules/user/middlewares/userSubscriber.middleware.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  MEDUSA_RESOLVER_KEYS,</span><br><span class="line">  MedusaAuthenticatedRequest,</span><br><span class="line">  MedusaMiddleware,</span><br><span class="line">  Utils <span class="keyword">as</span> MedusaUtils,</span><br><span class="line">  Middleware</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; NextFunction, Response &#125; <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Connection &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> UserSubscriber <span class="keyword">from</span> <span class="string">&#x27;../subscribers/user.subscriber&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@Middleware(&#123; <span class="attr">requireAuth</span>: <span class="literal">false</span>, <span class="attr">routes</span>: [&#123; <span class="attr">method</span>: <span class="string">&quot;post&quot;</span>, <span class="attr">path</span>: <span class="string">&#x27;/admin/users&#x27;</span> &#125;] &#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AttachUserSubscriberMiddleware</span> <span class="title">implements</span> <span class="title">MedusaMiddleware</span> </span>&#123;</span><br><span class="line">    public <span class="keyword">async</span> consume(req: MedusaAuthenticatedRequest, <span class="attr">res</span>: Response, <span class="attr">next</span>: NextFunction): <span class="built_in">Promise</span>&lt;<span class="keyword">void</span>&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; connection &#125; = req.scope.resolve(MEDUSA_RESOLVER_KEYS.manager) <span class="keyword">as</span> &#123; <span class="attr">connection</span>: Connection &#125;;</span><br><span class="line">        MedusaUtils.attachOrReplaceEntitySubscriber(connection, UserSubscriber);</span><br><span class="line">        <span class="keyword">return</span> next();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>This will register the subscriber when a <code>POST</code> request is sent to <code>/admin/users</code>, which creates a new user.</p>
<p><strong>Create a User Router</strong></p>
<p>The last customization left is an optional one. By default, Medusa’s create user endpoint requires you to be authenticated as an admin. In a marketplace use case, you might want users to register on their own and create their own stores. If this is not the case for you, you can skip creating the following class.</p>
<p>Medusa Extender allows you to also override routes in Medusa. In this case, you’ll be adding the <code>/admin/create-user</code> route to accept non-authenticated requests.</p>
<p>Create the file <code>src/modules/user/routers/user.router.ts</code> and add the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Router &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> createUserHandler <span class="keyword">from</span> <span class="string">&#x27;@medusajs/medusa/dist/api/routes/admin/users/create-user&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> wrapHandler <span class="keyword">from</span> <span class="string">&#x27;@medusajs/medusa/dist/api/middlewares/await-middleware&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@Router(&#123;</span><br><span class="line">    routes: [</span><br><span class="line">        &#123;</span><br><span class="line">            requiredAuth: <span class="literal">false</span>,</span><br><span class="line">            path: <span class="string">&#x27;/admin/create-user&#x27;</span>,</span><br><span class="line">            method: <span class="string">&#x27;post&#x27;</span>,</span><br><span class="line">            handlers: [wrapHandler(createUserHandler)],</span><br><span class="line">        &#125;,</span><br><span class="line">    ],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRouter</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>You use the <code>@Router</code> decorator from <code>medusa-extender</code> to create a router. This router will accept a <code>routes</code> array which will either be added or override existing routes in your Medusa server. In this case, you override the <code>/admin/create-user</code> route and set <code>requiredAuth</code> to false.</p>
<p>To make sure that the <code>AttachUserSubscriberMiddleware</code> also runs for this new route (so that the before insert user event handlers run for this new route), make sure to add a new entry to the <code>routes</code> array:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@Middleware(&#123; <span class="attr">requireAuth</span>: <span class="literal">false</span>, <span class="attr">routes</span>: [&#123; <span class="attr">method</span>: <span class="string">&quot;post&quot;</span>, <span class="attr">path</span>: <span class="string">&#x27;/admin/users&#x27;</span> &#125;, &#123; <span class="attr">method</span>: <span class="string">&quot;post&quot;</span>, <span class="attr">path</span>: <span class="string">&#x27;/admin/create-user&#x27;</span> &#125;] &#125;)</span><br></pre></td></tr></table></figure>



<p><strong>Create a User Module</strong></p>
<p>You’ve added all the customizations necessary to associate a user with their own store. Now, you can create the User module using these files.</p>
<p>Create the file <code>src/modules/user/user.module.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; AttachUserSubscriberMiddleware &#125; <span class="keyword">from</span> <span class="string">&#x27;./middlewares/userSubscriber.middleware&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; LoggedInUserMiddleware &#125; <span class="keyword">from</span> <span class="string">&quot;./middlewares/loggedInUser.middleware&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; User &#125; <span class="keyword">from</span> <span class="string">&#x27;./entities/user.entity&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> UserRepository <span class="keyword">from</span> <span class="string">&#x27;./repositories/user.repository&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UserRouter &#125; <span class="keyword">from</span> <span class="string">&quot;./routers/user.router&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> UserService <span class="keyword">from</span> <span class="string">&#x27;./services/user.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> addStoreIdToUser1644946220401 <span class="keyword">from</span> <span class="string">&#x27;./migrations/user.migration&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@Module(&#123;</span><br><span class="line">    imports: [</span><br><span class="line">        User,</span><br><span class="line">        UserService,</span><br><span class="line">        UserRepository,</span><br><span class="line">        addStoreIdToUser1644946220401,</span><br><span class="line">        UserRouter,</span><br><span class="line">        LoggedInUserMiddleware,</span><br><span class="line">        AttachUserSubscriberMiddleware</span><br><span class="line">    ]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>If you didn’t create the <code>UserRouter</code> in the previous step then make sure to remove it from the <code>imports</code> array.</p>
</blockquote>
<p>The last thing left is to import this Module. In <code>src/main.ts</code> import <code>UserModule</code> at the beginning of the file:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; UserModule &#125; <span class="keyword">from</span> <span class="string">&#x27;./modules/user/user.module&#x27;</span>;</span><br></pre></td></tr></table></figure>



<p>Then, add the <code>UserModule</code> in the array passed as a parameter to <code>Medusa.load</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="keyword">new</span> Medusa(__dirname + <span class="string">&#x27;/../&#x27;</span>, expressInstance).load([</span><br><span class="line">        UserModule,</span><br><span class="line">        StoreModule</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>



<p><strong>Test it Out</strong></p>
<p>You are now ready to test out this customization! In your terminal, run your Medusa server:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm start</span><br></pre></td></tr></table></figure>



<p>Or using Medusa’s CLI:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">medusa develop</span><br></pre></td></tr></table></figure>



<p>After your run your server, you need to use a tool like <a target="_blank" rel="noopener" href="https://www.postman.com/">Postman</a> to easily send requests to your server.</p>
<p>If you didn’t add the <code>UserRouter</code>, you first need to log in as an admin to be able to add users. You can do that by sending a <code>POST</code> request to <code>localhost:9000/admin/auth</code>. In the body, you should include the email and password. If you’re using a fresh Medusa install you can use the following credentials:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;email&quot;</span>: <span class="string">&quot;admin@medusa-test.com&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;password&quot;</span>: <span class="string">&quot;supersecret&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>Following this request, you can send authenticated requests to the Admin.</p>
<p>Send a <code>POST</code> request to <code>[localhost:9000/admin/users](http://localhost:9000/admin/users)</code> to create a new user. In the body, you need to pass the email and password of the new user:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;email&quot;</span>: <span class="string">&quot;example@gmail.com&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;password&quot;</span>: <span class="string">&quot;supersecret&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>The request will return a user object with the details of the new user:</p>
<p>![Create User Result](Open source ecommerce platform for multi-vendor marketplaces/1.png)Notice how there’s a <code>store_id</code> field now. If you try to create a couple of users, you’ll see that the <code>store_id</code> will be different each time.</p>
<h3 id="Customize-the-Products-Entity"><a href="#Customize-the-Products-Entity" class="headerlink" title="Customize the Products Entity"></a>Customize the Products Entity</h3><p>Similar to how you just customized the <code>User</code> entity, you need to customize the <code>Product</code> entity to also hold the <code>store_id</code> with the relationship as well. You’ll then customize the <code>ProductService</code> as well as other classes to make sure that, when a product is created, the store ID of the user creating it is attached to it. You’ll also make sure that when the list of products is fetched, only the products that belong to the current user’s store are returned.</p>
<p><strong>Create a Product Entity</strong></p>
<p>Create the file <code>src/modules/product/entities/product.entity.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Product <span class="keyword">as</span> MedusaProduct &#125; <span class="keyword">from</span> <span class="string">&#x27;@medusajs/medusa/dist&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Column, Entity, Index, JoinColumn, ManyToOne &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Entity <span class="keyword">as</span> MedusaEntity &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Store &#125; <span class="keyword">from</span> <span class="string">&#x27;../../store/entities/store.entity&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@MedusaEntity(&#123; <span class="attr">override</span>: MedusaProduct &#125;)</span><br><span class="line">@Entity()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Product</span> <span class="keyword">extends</span> <span class="title">MedusaProduct</span> </span>&#123;</span><br><span class="line">    @Index()</span><br><span class="line">    @Column(&#123; <span class="attr">nullable</span>: <span class="literal">false</span> &#125;)</span><br><span class="line">    store_id: string;</span><br><span class="line"></span><br><span class="line">    @ManyToOne(<span class="function">() =&gt;</span> Store, <span class="function">(<span class="params">store</span>) =&gt;</span> store.members)</span><br><span class="line">    @JoinColumn(&#123; <span class="attr">name</span>: <span class="string">&#x27;store_id&#x27;</span>, <span class="attr">referencedColumnName</span>: <span class="string">&#x27;id&#x27;</span> &#125;)</span><br><span class="line">    store: Store;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>This will override Medusa’s <code>Product</code> entity to add the <code>store_id</code> field and relation to the <code>Store</code> entity.</p>
<p>You need to also reflect this relation in the <code>Store</code> entity, so, in <code>src/modules/store/entities/store.entity.ts</code> add the following code below the relation with the <code>User</code> entity you previously added:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@OneToMany(<span class="function">() =&gt;</span> Product, <span class="function">(<span class="params">product</span>) =&gt;</span> product.store)</span><br><span class="line">@JoinColumn(&#123; <span class="attr">name</span>: <span class="string">&#x27;id&#x27;</span>, <span class="attr">referencedColumnName</span>: <span class="string">&#x27;store_id&#x27;</span> &#125;)</span><br><span class="line">products: Product[];</span><br></pre></td></tr></table></figure>



<p>Make sure to import the <code>Product</code> entity at the beginning of the file:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Product &#125; <span class="keyword">from</span> <span class="string">&#x27;../../product/entities/product.entity&#x27;</span>;</span><br></pre></td></tr></table></figure>



<p><strong>Create a Product Migration</strong></p>
<p>Next, create the file <code>src/modules/product/migrations/product.migration.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; MigrationInterface, QueryRunner &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Migration &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@Migration()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">addStoreIdToProduct1645034402086</span> <span class="title">implements</span> <span class="title">MigrationInterface</span> </span>&#123;</span><br><span class="line">    name = <span class="string">&#x27;addStoreIdToProduct1645034402086&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">async</span> up(queryRunner: QueryRunner): <span class="built_in">Promise</span>&lt;<span class="keyword">void</span>&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> query = <span class="string">`ALTER TABLE public.&quot;product&quot; ADD COLUMN IF NOT EXISTS &quot;store_id&quot; text;`</span>;</span><br><span class="line">      <span class="keyword">await</span> queryRunner.query(query);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">async</span> down(queryRunner: QueryRunner): <span class="built_in">Promise</span>&lt;<span class="keyword">void</span>&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> query = <span class="string">`ALTER TABLE public.&quot;product&quot; DROP COLUMN &quot;store_id&quot;;`</span>;</span><br><span class="line">      <span class="keyword">await</span> queryRunner.query(query);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>This will add a migration that will add the <code>store_id</code> column to the <code>product</code> table.</p>
<p><strong>Create a Product Repository</strong></p>
<p>Next, create the file <code>src/modules/product/repositories/product.repository.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Repository <span class="keyword">as</span> MedusaRepository, Utils &#125; <span class="keyword">from</span> <span class="string">&quot;medusa-extender&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; EntityRepository &#125; <span class="keyword">from</span> <span class="string">&quot;typeorm&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ProductRepository <span class="keyword">as</span> MedusaProductRepository &#125; <span class="keyword">from</span> <span class="string">&quot;@medusajs/medusa/dist/repositories/product&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Product &#125; <span class="keyword">from</span> <span class="string">&#x27;../entities/product.entity&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@MedusaRepository(&#123; <span class="attr">override</span>: MedusaProductRepository &#125;)</span><br><span class="line">@EntityRepository(Product)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductRepository</span> <span class="keyword">extends</span> <span class="title">Utils</span>.<span class="title">repositoryMixin</span>&lt;<span class="title">Product</span>, <span class="title">MedusaProductRepository</span>&gt;(<span class="title">MedusaProductRepository</span>) </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>This will override Medusa’s <code>ProductRepository</code> to return your new <code>Product</code> entity.</p>
<p><strong>Create a Product Service</strong></p>
<p>Now, you’ll add the customization to ensure that only the products that belong to the currently logged-in user are returned when a request is sent.</p>
<p>Since you created the <code>LoggedInUserMiddleware</code> earlier, you can have access to the logged-in user from any service through the <code>container</code> object passed to the constructor of the service.</p>
<p>Create the file <code>src/modules/product/services/product.service.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; EntityEventType, MedusaEventHandlerParams, OnMedusaEntityEvent, Service &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; EntityManager &#125; <span class="keyword">from</span> <span class="string">&quot;typeorm&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ProductService <span class="keyword">as</span> MedusaProductService &#125; <span class="keyword">from</span> <span class="string">&#x27;@medusajs/medusa/dist/services&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Product &#125; <span class="keyword">from</span> <span class="string">&#x27;../entities/product.entity&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; User &#125; <span class="keyword">from</span> <span class="string">&#x27;../../user/entities/user.entity&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> UserService <span class="keyword">from</span> <span class="string">&#x27;../../user/services/user.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line">type ConstructorParams = &#123;</span><br><span class="line">    manager: any;</span><br><span class="line">    loggedInUser: User;</span><br><span class="line">    productRepository: any;</span><br><span class="line">    productVariantRepository: any;</span><br><span class="line">    productOptionRepository: any;</span><br><span class="line">    eventBusService: any;</span><br><span class="line">    productVariantService: any;</span><br><span class="line">    productCollectionService: any;</span><br><span class="line">    productTypeRepository: any;</span><br><span class="line">    productTagRepository: any;</span><br><span class="line">    imageRepository: any;</span><br><span class="line">    searchService: any;</span><br><span class="line">    userService: UserService;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Service(&#123; <span class="attr">scope</span>: <span class="string">&#x27;SCOPED&#x27;</span>, <span class="attr">override</span>: MedusaProductService &#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductService</span> <span class="keyword">extends</span> <span class="title">MedusaProductService</span> </span>&#123;</span><br><span class="line">    readonly #manager: EntityManager;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">private readonly container: ConstructorParams</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(container);</span><br><span class="line">        <span class="built_in">this</span>.#manager = container.manager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    prepareListQuery_(selector: object, <span class="attr">config</span>: object): object &#123;</span><br><span class="line">        <span class="keyword">const</span> loggedInUser = <span class="built_in">this</span>.container.loggedInUser</span><br><span class="line">        <span class="keyword">if</span> (loggedInUser) &#123;</span><br><span class="line">            selector[<span class="string">&#x27;store_id&#x27;</span>] = loggedInUser.store_id</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.prepareListQuery_(selector, config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>This will override the <code>prepareListQuery</code> method in Medusa’s <code>ProductService</code>, which this new class extends, to get the logged-in user. Then, if the user is retrieved successfully the key <code>store_id</code> is added to the <code>selector</code> object to filter the products by the user’s <code>store_id</code>.</p>
<p><strong>Create a Product Module</strong></p>
<p>That’s all the customization you’ll do for now. You just need to import all these files into a Product module.</p>
<p>Create <code>src/modules/product/product.module.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Product &#125; <span class="keyword">from</span> <span class="string">&#x27;./entities/product.entity&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> ProductRepository <span class="keyword">from</span> <span class="string">&#x27;./repositories/product.repository&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ProductService &#125; <span class="keyword">from</span> <span class="string">&#x27;./services/product.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> addStoreIdToProduct1645034402086 <span class="keyword">from</span> <span class="string">&#x27;./migrations/product.migration&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@Module(&#123;</span><br><span class="line">    imports: [</span><br><span class="line">      Product,</span><br><span class="line">      ProductRepository,</span><br><span class="line">      ProductService,</span><br><span class="line">      addStoreIdToProduct1645034402086,</span><br><span class="line">    ]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>



<p>Finally, import the <code>ProductModule</code> at the beginning of <code>src/main.ts</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ProductModule &#125; <span class="keyword">from</span> <span class="string">&#x27;./modules/product/product.module&#x27;</span>;</span><br></pre></td></tr></table></figure>



<p>And add the <code>ProductModule</code> to the array passed to <code>load</code> along with <code>UserModule</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="keyword">new</span> Medusa(__dirname + <span class="string">&#x27;/../&#x27;</span>, expressInstance).load([</span><br><span class="line">    UserModule,</span><br><span class="line">    ProductModule,</span><br><span class="line">    StoreModule</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>



<p><strong>Test it Out</strong></p>
<p>You can go ahead and test it out now. Run the server if it isn’t running already and log in with the user you created earlier by sending the credentials to <code>localhost:9000/admin/auth</code>.</p>
<p>After that, send a <code>GET</code> request to <code>localhost:9000/admin/products</code>. You’ll receive an empty array of products as the current user does not have any products yet.</p>
<p>![Result of Get Products](Open source ecommerce platform for multi-vendor marketplaces/2.png)</p>
<p>You’ll now add the necessary customization to attach a store ID to a newly created product.</p>
<p>To listen to the product created event, create the file <code>src/modules/product/subscribers/product.subscriber.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Connection, EntitySubscriberInterface, EventSubscriber, InsertEvent &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; OnMedusaEntityEvent, Utils, eventEmitter &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Product &#125; <span class="keyword">from</span> <span class="string">&#x27;../entities/product.entity&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@EventSubscriber()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductSubscriber</span> <span class="title">implements</span> <span class="title">EntitySubscriberInterface</span>&lt;<span class="title">Product</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> attachTo(connection: Connection): <span class="keyword">void</span> &#123;</span><br><span class="line">        Utils.attachOrReplaceEntitySubscriber(connection, ProductSubscriber);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public listenTo(): <span class="keyword">typeof</span> Product &#123;</span><br><span class="line">        <span class="keyword">return</span> Product;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">async</span> beforeInsert(event: InsertEvent&lt;Product&gt;): <span class="built_in">Promise</span>&lt;<span class="keyword">void</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> eventEmitter.emitAsync(OnMedusaEntityEvent.Before.InsertEvent(Product), &#123;</span><br><span class="line">            event,</span><br><span class="line">            transactionalEntityManager: event.manager,</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>Then, you need to register this Subscriber using Middleware. Create the file <code>src/modules/product/middlewares/product.middleware.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  MEDUSA_RESOLVER_KEYS,</span><br><span class="line">  MedusaAuthenticatedRequest,</span><br><span class="line">  MedusaMiddleware,</span><br><span class="line">  Utils <span class="keyword">as</span> MedusaUtils,</span><br><span class="line">  Middleware</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; NextFunction, Request, Response &#125; <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Connection &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> ProductSubscriber <span class="keyword">from</span> <span class="string">&#x27;../subscribers/product.subscriber&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@Middleware(&#123; <span class="attr">requireAuth</span>: <span class="literal">true</span>, <span class="attr">routes</span>: [&#123; <span class="attr">method</span>: <span class="string">&#x27;post&#x27;</span>, <span class="attr">path</span>: <span class="string">&#x27;/admin/products&#x27;</span> &#125;] &#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">AttachProductSubscribersMiddleware</span> <span class="title">implements</span> <span class="title">MedusaMiddleware</span> </span>&#123;</span><br><span class="line">    public consume(req: MedusaAuthenticatedRequest | Request, <span class="attr">res</span>: Response, <span class="attr">next</span>: NextFunction): <span class="keyword">void</span> | <span class="built_in">Promise</span>&lt;<span class="keyword">void</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; connection &#125; = req.scope.resolve(MEDUSA_RESOLVER_KEYS.manager) <span class="keyword">as</span> &#123; <span class="attr">connection</span>: Connection &#125;;</span><br><span class="line">        MedusaUtils.attachOrReplaceEntitySubscriber(connection, ProductSubscriber);</span><br><span class="line">        <span class="keyword">return</span> next();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>This will register the subscriber when a <code>POST</code> request is sent to <code>/admin/products</code>, which creates a new product.</p>
<p><strong>Add Event Listener in Product Service</strong></p>
<p>Next, in <code>src/modules/product/services/product.service.ts</code> add the following inside the class:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@OnMedusaEntityEvent.Before.Insert(Product, &#123; <span class="attr">async</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">public <span class="keyword">async</span> attachStoreToProduct(</span><br><span class="line">    params: MedusaEventHandlerParams&lt;Product, <span class="string">&#x27;Insert&#x27;</span>&gt;</span><br><span class="line">): <span class="built_in">Promise</span>&lt;EntityEventType&lt;Product, <span class="string">&#x27;Insert&#x27;</span>&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; event &#125; = params;</span><br><span class="line">    <span class="keyword">const</span> loggedInUser = <span class="built_in">this</span>.container.loggedInUser;</span><br><span class="line">    event.entity.store_id = loggedInUser.store_id;</span><br><span class="line">    <span class="keyword">return</span> event;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>This will listen to the Insert event using the <code>@OnMedusaEntityEvent</code> decorator from <code>medusa-extender</code>. It will then use the logged-in user and attach the user’s <code>store_id</code> to the newly created product.</p>
<p><strong>Add Middleware to Product Module</strong></p>
<p>Finally, make sure to import the new middleware at the beginning of <code>src/modules/product/product.module.ts</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> AttachProductSubscribersMiddleware <span class="keyword">from</span> <span class="string">&#x27;./middlewares/product.middleware&#x27;</span>;</span><br></pre></td></tr></table></figure>



<p>Then, add it in the <code>imports</code> array passed to <code>@Module</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">imports: [</span><br><span class="line">  Product,</span><br><span class="line">  ProductRepository,</span><br><span class="line">  ProductService,</span><br><span class="line">  addStoreIdToProduct1645034402086,</span><br><span class="line">  AttachProductSubscribersMiddleware</span><br><span class="line">]</span><br></pre></td></tr></table></figure>



<p>You’re ready to add products into a store now! Run the server if it’s not running and make sure you’re logged in with the user you created earlier. Then, send a <code>POST</code> request to <code>[localhost:9000/admin/products](http://localhost:9000/admin/products)</code> with the following body:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;title&quot;</span>: <span class="string">&quot;my product&quot;</span>,</span><br><span class="line">    <span class="string">&quot;options&quot;</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>This is the minimum structure of a product. You can rename the title to anything you want.</p>
<p>After you send the request, you should receive a Product object where you can see the <code>store_id</code> is set to the same <code>store_id</code> of the user you’re logged in with.</p>
<p>![Add Product Request Result](Open source ecommerce platform for multi-vendor marketplaces/3.png)</p>
<p>Now, try sending a <code>GET</code> request to <code>[localhost:9000/admin/products](http://localhost:9000/admin/products)</code> as you did earlier. Instead of an empty array, you’ll see the product you just added.</p>
<p>![Retrieve Products](Open source ecommerce platform for multi-vendor marketplaces/4.png)</p>
<h2 id="Testing-it-Out-Using-Medusa’s-Admin"><a href="#Testing-it-Out-Using-Medusa’s-Admin" class="headerlink" title="Testing it Out Using Medusa’s Admin"></a>Testing it Out Using Medusa’s Admin</h2><p>If you also have a <a target="_blank" rel="noopener" href="https://github.com/medusajs/admin">Medusa Admin</a> instance installed, you can also test this out. Log in with the user you created earlier and you’ll see that you can only see the product they added.</p>
<p>![Admin Dashboard](Open source ecommerce platform for multi-vendor marketplaces/5.png)</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>In this tutorial, you learned the first steps of creating a Marketplace using Medusa and Medusa Extender! In later points, you’ll learn about how you can add settings, manage orders, and more!</p>
<p>Be sure to support <a target="_blank" rel="noopener" href="https://github.com/adrien2p/medusa-extender">Medusa Extender</a> and check the repository out for more details!</p>
<p>Should you have any issues or questions related to Medusa, then feel free to reach out to the Medusa team via <a target="_blank" rel="noopener" href="https://discord.gg/F87eGuwkTp">Discord</a>. You can also contact Adrien <code>@adrien2p</code> for more details or help regarding Medusa Extender.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://willzhuang.github.io/2022/04/08/IBFT%E6%98%AF%E4%BB%80%E4%B9%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Weiming Zhuang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhuang's Diary">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/04/08/IBFT%E6%98%AF%E4%BB%80%E4%B9%88/" class="post-title-link" itemprop="url">IBFT是什么</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-04-08 14:43:00 / Modified: 14:54:20" itemprop="dateCreated datePublished" datetime="2022-04-08T14:43:00+08:00">2022-04-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Istanbul Byzantine Fault Tolerance (IBFT) is a proof-of-authority blockchain consensus protocol that ensures immediate finality. IBFT Consensus is inspired by <a target="_blank" rel="noopener" href="http://pmg.csail.mit.edu/papers/osdi99.pdf">Castro-Liskov 99 PBFT paper</a>. </p>
<ul>
<li>在 IBFT 中，没有客户端向网络提交请求；这些验证者节点之一将被任意选择为提议者。这个单一的提议者在收到来自验证者池的消息后，将决定将什么添加到链中。</li>
<li>与 PBFT 相同，区块由PREPREPARE - PREPARE - COMMIT三个阶段。</li>
<li>IBFT 允许两种类型的节点：参与共识协议的验证者和验证区块但不参与共识协议的标准节点。（与tendermint相同）。</li>
<li>PBFT 中的验证器集是静态的，而 IBFT 具有动态验证器集，可以将验证器添加到集合中或从中删除。</li>
<li>IBFT 规定了 PBFT 的所谓 View-Change 消息的简化版本，不包括 PBFT 协议中包含的所谓 New-View 消息。<br>虽然 IBFT 没有明确使用检查点，但每个 IBFT 块都可以被视为 PBFT 检查点的 IBFT 等效项。</li>
</ul>
<p>采用IBFT的区块链有 Consensys Quorum 和 Besu。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://willzhuang.github.io/2022/04/01/%E6%B7%B1%E5%85%A5gnosis-safe/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Weiming Zhuang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhuang's Diary">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/04/01/%E6%B7%B1%E5%85%A5gnosis-safe/" class="post-title-link" itemprop="url">深入gnosis-safe</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-04-01 22:43:00 / Modified: 22:45:47" itemprop="dateCreated datePublished" datetime="2022-04-01T22:43:00+08:00">2022-04-01</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://blog.logrocket.com/build-treasury-wallet-multisignature-gnosis-safe/">Build a treasury wallet with multisignature Gnosis Safe - LogRocket Blog</a></p>
<p>Imagine you and your friends are building an <a target="_blank" rel="noopener" href="https://blog.logrocket.com/create-nft-upload-metadata-ipfs/">NFT marketplace</a>. You are the CEO and your friend works as a Solidity engineer who writes the smart contract. The NFT marketplace becomes popular, and your revenue builds from the market fee of every NFT sale transaction. You store your profit inside a smart contract, and boast to the media about your company that has enough money to buy a private island. Then, the Solidity engineer disappears and withdraws all the funds from the treasury. You watch in horror.</p>
<p>Now, you vow not to fall into the same trap again. From now on, every sensitive transaction in a smart contract needs approval from a certain number of people. For example, withdrawing funds from your treasury requires at least 60 percent approval from certain key people. If there are five key people, at least three approvals are needed.</p>
<p>Luckily, you don’t need to build this mechanism from scratch; you can use <a target="_blank" rel="noopener" href="https://gnosis-safe.io/">Gnosis Safe</a> to interact with your NFT marketplace. You put the funds inside the Gnosis Safe smart contracts, and withdrawing the funds now requires at least a certain number of signatures. A rogue agent cannot steal the funds anymore, and you’re back to saving up for a private island!</p>
<p>Gnosis Safe is a project from <a target="_blank" rel="noopener" href="https://gnosis.io/">Gnosis</a>. Gnosis started as a <a target="_blank" rel="noopener" href="https://whitepaper.io/document/116/gnosis-whitepaper">prediction markets platform</a> where people can trade information freely. As part of the project, the team behind Gnosis created Gnosis Safe to secure funds for multiple participants. Today, it’s the most popular multisig wallet smart contract on Ethereum. Search “multisig wallet Ethereum” on Google and you will find Gnosis in the top results.</p>
<p>In this article, you will learn how to set up a treasury wallet with Gnosis Safe, so you can protect your funds on the Ethereum blockchain.</p>
<h2 id="Setting-up-Gnosis-Safe-smart-contracts"><a href="#Setting-up-Gnosis-Safe-smart-contracts" class="headerlink" title="Setting up Gnosis Safe smart contracts"></a>Setting up Gnosis Safe smart contracts</h2><p>You can clone the Gnosis Safe smart contract from their GitHub repo like so:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> https://github.com/gnosis/safe-contracts.git</span></span><br></pre></td></tr></table></figure>

<p>Use a specific version so you can follow this tutorial:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> safe-contracts</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git checkout v1.3.0-libs.0</span></span><br></pre></td></tr></table></figure>

<p>With this specific version, the deployed addresses of Gnosis Safe will be deterministic.</p>
<p>Let’s deploy Gnosis Safe to the <a target="_blank" rel="noopener" href="https://hardhat.org/">Hardhat</a> development network. But first, you must install Hardhat inside the <code>safe-contracts</code> directory:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> yarn add hardhat</span></span><br></pre></td></tr></table></figure>

<p>Then, run the Hardhat development network and deploy the Gnosis Safe smart contracts:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npx hardhat node</span></span><br><span class="line">Nothing to compile</span><br><span class="line">sending eth to create2 contract deployer address (0x3fab184622dc19b6109349b94811493bf2a45362) (tx: 0x076c3e6eb9678931c92e0322885f48ebdc064226483a9bae4866f99c7f8aa8bb)...</span><br><span class="line">deploying create2 deployer contract (at 0x4e59b44847b379578588920ca78fbf26c0b4956c) using deterministic deployment (https://github.com/Arachnid/deterministic-deployment-proxy) (tx: 0xeddf9e61fb9d8f5111840daef55e5fde0041f5702856532cdbb5a02998033d26)...</span><br><span class="line">deploying &quot;SimulateTxAccessor&quot; (tx: 0xfc6d7c491688840e79ed7d8f0fc73494be305250f0d5f62d04c41bc4467e8603)...: deployed at 0x59AD6735bCd8152B84860Cb256dD9e96b85F69Da with 237871 gas</span><br><span class="line">deploying &quot;GnosisSafeProxyFactory&quot; (tx: 0x6fff529768b3c5660234fcd53d5d04918aadc935a90ec05aca1796649bf4f699)...: deployed at 0xa6B71E26C5e0845f74c812102Ca7114b6a896AB2 with 867594 gas</span><br><span class="line">deploying &quot;DefaultCallbackHandler&quot; (tx: 0x406498f13d684b2db11ac78d1b06c2b38657f02e729ecebc677b7ea28a30e712)...: deployed at 0x1AC114C2099aFAf5261731655Dc6c306bFcd4Dbd with 542473 gas</span><br><span class="line">deploying &quot;CompatibilityFallbackHandler&quot; (tx: 0xe7426790ce3fed5ba2083b5e5b911b561a306d3f26fbd5c0d0d6c0c1d5847e3f)...: deployed at 0xf48f2B2d2a534e402487b3ee7C18c33Aec0Fe5e4 with 1238095 gas</span><br><span class="line">deploying &quot;CreateCall&quot; (tx: 0xa602d00962fa8de99f84dbefd62f831f179d12e549863bd305607bbb775f5c81)...: deployed at 0x7cbB62EaA69F79e6873cD1ecB2392971036cFAa4 with 294718 gas</span><br><span class="line">deploying &quot;MultiSend&quot; (tx: 0x8790b4413d0b4336586897f0bf40a72cdcfcb8fd06aed8a164fac5ecf662e0f6)...: deployed at 0xA238CBeb142c10Ef7Ad8442C6D1f9E89e07e7761 with 190004 gas</span><br><span class="line">deploying &quot;MultiSendCallOnly&quot; (tx: 0xb4ccc0ce8099412d505d0ab131ce9fffb1915a5053906875fc301528ebe79f1a)...: deployed at 0x40A2aCCbd92BCA938b02010E17A5b8929b49130D with 142122 gas</span><br><span class="line">deploying &quot;SignMessageLib&quot; (tx: 0xdf0d113415ea15354de8e816b793ca89e5a9a7d4ad7b48e1344872d0f4aacdbf)...: deployed at 0xA65387F16B013cf2Af4605Ad8aA5ec25a2cbA3a2 with 262353 gas</span><br><span class="line">deploying &quot;GnosisSafeL2&quot; (tx: 0x83b42dd66a2e282b3e76cb10fb4ab93da970b0454010faef142ab8c6a5c4233d)...: deployed at 0x3E5c63644E683549055b9Be8653de26E0B4CD36E with 5200241 gas</span><br><span class="line">deploying &quot;GnosisSafe&quot; (tx: 0xea94214f16af5e66646518db2403a6e24b17973d6bbb0208fc40f01343b0225f)...: deployed at 0xd9Db270c1B5E3Bd161E8c8503c55cEABeE709552 with 5017833 gas</span><br><span class="line">Started HTTP and WebSocket JSON-RPC server at http://127.0.0.1:8545/</span><br></pre></td></tr></table></figure>

<p>The Gnosis Safe smart contracts are not just one smart contract; they are many. But you need to pay attention to three smart contracts in particular: <code>MultiSend</code>, <code>GnosisSafe</code>, and <code>GnosisSafeProxyFactory</code>. You need their addresses when you use the Gnosis Safe SDK later.</p>
<p>So what are these three smart contracts?</p>
<p><code>GnosisSafe</code> is the core safe smart contract, and everyone only needs one. Your startup and your business competitors can use the same deployed <code>GnosisSafe</code>, so you don’t need to deploy it separately if it has been deployed already.</p>
<p>You don’t interact directly with <code>GnosisSafe</code>. You use a proxy, called <code>GnosisSafeProxy</code>. Because of this, your startup and your business competitor need to use different <code>GnosisSafeProxy</code>s. To create your own <code>GnosisSafeProxy</code>, you can use <code>GnosisSafeProxyFactory</code>.</p>
<p><code>MultiSend</code> is a helper smart contract to batch multiple transactions into one. You may want to buy a yacht as your startup office, pay salary to a meme artist, and pay taxes to the country where your startup resides. Instead of executing these transactions one by one, you can batch them into one with this helper smart contract, then execute them in one go.</p>
<p>There are other smart contracts as part of the Gnosis Safe, but you don’t touch them directly. You only deal with the three smart contracts mentioned previously. That’s why the Gnosis Safe SDK requires you to provide their addresses.</p>
<p>If you use Gnosis Safe in other networks like Ethereum mainnet or Rinkeby, you don’t need to deploy the Gnosis Safe smart contracts because the team behind Gnosis Safe already deployed these core ones. You just need to find their addresses and write them down. But since you are using the Hardhat development network, you need to do this step.</p>
<p>Let the process run peacefully. You can open a new terminal and create your project that interacts with these smart contracts in the new terminal.</p>
<h2 id="Installing-the-Gnosis-Safe-SDK-libraries"><a href="#Installing-the-Gnosis-Safe-SDK-libraries" class="headerlink" title="Installing the Gnosis Safe SDK libraries"></a>Installing the Gnosis Safe SDK libraries</h2><p>The Gnosis Safe SDK libraries are Node.js libraries. To use them, you need to create a Node project. Let’s create one by creating an empty directory and initialize it with yarn:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mkdir our-treasury</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> our-treasury</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> yarn init -y</span></span><br><span class="line">yarn init v1.22.11</span><br><span class="line">warning The yes flag has been set. This will automatically answer yes to all questions, which may have security implications.</span><br><span class="line">success Saved package.json</span><br><span class="line">Done in 0.02s.</span><br><span class="line"><span class="meta">$</span><span class="bash"> ls</span></span><br><span class="line">package.json</span><br></pre></td></tr></table></figure>

<p>To interact with Ethereum in Node, you have two choices: <code>web3.js</code> and <code>ethers.js</code>. In this tutorial, you’ll use the <code>ethers.js</code> library. Install the library with yarn like so:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> yarn add ethers</span></span><br></pre></td></tr></table></figure>

<p>You will put the Ethereum addresses on the <code>.env</code> file instead of hard-coding them, so you need the <code>dotenv</code> library:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> yarn add dotenv</span></span><br></pre></td></tr></table></figure>

<p>Lastly, you need the Gnosis Safe SDK libraries:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> yarn add @gnosis.pm/safe-core-sdk @gnosis.pm/safe-ethers-lib</span></span><br></pre></td></tr></table></figure>

<p>These are the core libraries that you’re going to learn how to use in this tutorial to interface with the Gnosis Safe smart contracts.</p>
<h2 id="Setting-up-the-env-file"><a href="#Setting-up-the-env-file" class="headerlink" title="Setting up the .env file"></a>Setting up the .env file</h2><p>Instead of hard-coding the Ethereum addresses, you can store them as environment variables. But setting up environment variables in a terminal before executing a script is a hassle:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">export</span> ACCOUNT_1=0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">export</span> ACCOUNT_2=0x70997970c51812dc3a010c7d01b50e0d17dc79c8</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">$</span><span class="bash"> node index.js</span></span><br></pre></td></tr></table></figure>

<p>It’s better if you use the <code>.env</code> file. Basically, you use the <code>dotenv</code> library to load the environment variables from the <code>.env</code> file. That way, you only need to set up the environment variables once.</p>
<p>Create the <code>.env</code> file with the following content:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ACCOUNT_1=&quot;0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266&quot;</span><br><span class="line">ACCOUNT_2=&quot;0x70997970c51812dc3a010c7d01b50e0d17dc79c8&quot;</span><br><span class="line">ACCOUNT_3=&quot;0x3c44cdddb6a900fa2b585dd299e03d12fa4293bc&quot;</span><br><span class="line">ACCOUNT_4=&quot;0x90f79bf6eb2c4f870365e785982e1f101e93b906&quot;</span><br><span class="line">ACCOUNT_5=&quot;0x15d34aaf54267db7d7c367839aaf71a00a2c6a65&quot;</span><br><span class="line">ACCOUNT_6=&quot;0x9965507d1a55bcc2695c58ba16fb37d819b0a4dc&quot;</span><br><span class="line">ACCOUNT_7=&quot;0x976ea74026e726554db657fa54763abd0c3a0aa9&quot;</span><br><span class="line">MULTI_SEND_ADDRESS=&quot;0xA238CBeb142c10Ef7Ad8442C6D1f9E89e07e7761&quot;</span><br><span class="line">SAFE_MASTER_COPY_ADDRESS=&quot;0xd9Db270c1B5E3Bd161E8c8503c55cEABeE709552&quot;</span><br><span class="line">SAFE_PROXY_FACTORY_ADDRESS=&quot;0xa6B71E26C5e0845f74c812102Ca7114b6a896AB2&quot;</span><br></pre></td></tr></table></figure>

<p>In the code above, you can see that the addresses for <code>MULTI_SEND_ADDRESS</code>, <code>SAFE_MASTER_COPY_ADDRESS</code>, <code>SAFE_PROXY_FACTORY_ADDRESS</code> are the same as the ones in the first terminal. As a reminder, the first terminal is the terminal where you’ve deployed the Gnosis Safe smart contracts on the Hardhat development network. Later, in your client code, you will load these smart contracts’ addresses from the <code>.env</code> file to interact with the deployed smart contracts on the Hardhat development network.</p>
<p>The <code>ACCOUNT_1</code> and other accounts are the sample Ethereum addresses provided by the Hardhat development node. If you run <code>npx hardhat node</code> in a new Hardhat project, you will get 20 sample Ethereum addresses with their private keys for development. Each account has 10,000ETH. In this <code>.env</code> file, you just took the first seven addresses.</p>
<h2 id="Creating-the-treasury"><a href="#Creating-the-treasury" class="headerlink" title="Creating the treasury"></a>Creating the treasury</h2><p>Let’s create the <code>index.js</code> file. This is where you will write the code to build the treasury with Gnosis Safe:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> edit index.js <span class="comment"># replace edit with vim or code or your favorite editor</span></span></span><br></pre></td></tr></table></figure>

<p>First things first, you want to be able to read the variables you put in the <code>.env</code> file. So add this line:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;dotenv&#x27;</span>).config();</span><br></pre></td></tr></table></figure>

<p>Then, you import the Gnosis Safe SDK library:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; SafeFactory, SafeAccountConfig, ContractNetworksConfig &#125; = <span class="built_in">require</span>(<span class="string">&#x27;@gnosis.pm/safe-core-sdk&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> Safe = <span class="built_in">require</span>(<span class="string">&#x27;@gnosis.pm/safe-core-sdk&#x27;</span>)[<span class="string">&quot;default&quot;</span>];</span><br></pre></td></tr></table></figure>

<p>To make things clearer, imagine that you’re creating a web3 startup to disrupt traditional banks. There are five people who are building this startup, with you acting as the CEO. The other people on the team are the CTO, a Solidity engineer, a meme artist, and an advisor.</p>
<p>An angel investor sends money to your startup. The money is put inside the safe smart contract. It takes three of five signatures from your team to approve any transactions related to this smart contract. You, as the CEO, decide to buy a yacht for your startup office. You will need two other signatures from your team to approve this transaction. Let’s do it!</p>
<h2 id="Setting-up-multisignature-authorization-in-Gnosis-Safe-wallet"><a href="#Setting-up-multisignature-authorization-in-Gnosis-Safe-wallet" class="headerlink" title="Setting up multisignature authorization in Gnosis Safe wallet"></a>Setting up multisignature authorization in Gnosis Safe wallet</h2><p>To protect your company’s treasury from being emptied by a single member, you have to make sure that three out of your five team members approve of the yacht purchase. Let’s add this functionality now.</p>
<p>Still in the same file, <code>index.js</code>, add these lines below the <code>const Safe = require…</code> line:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ceo = process.env.ACCOUNT_1;</span><br><span class="line"><span class="keyword">const</span> cto = process.env.ACCOUNT_2;</span><br><span class="line"><span class="keyword">const</span> meme_artist = process.env.ACCOUNT_3;</span><br><span class="line"><span class="keyword">const</span> solidity_engineer = process.env.ACCOUNT_4;</span><br><span class="line"><span class="keyword">const</span> advisor = process.env.ACCOUNT_5;</span><br><span class="line"><span class="keyword">const</span> investor = process.env.ACCOUNT_6;</span><br><span class="line"><span class="keyword">const</span> yacht_shop = process.env.ACCOUNT_7;</span><br></pre></td></tr></table></figure>

<p>Here, you load up the addresses you stored on the <code>.env</code> file in <code>index.js</code>. This way, to change the addresses, you don’t need to change the code.</p>
<p>Then, set up a provider from the <code>ethers.js</code> library:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; ethers &#125; = <span class="built_in">require</span>(<span class="string">&#x27;ethers&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> provider = <span class="keyword">new</span> ethers.providers.JsonRpcProvider();</span><br></pre></td></tr></table></figure>

<p>A <a target="_blank" rel="noopener" href="https://docs.ethers.io/v5/api/providers/provider/">provider</a> is an Ethereum connection object. Here, you create an abstraction of a JSON-RPC connection to an Ethereum node.</p>
<p>From this provider, you create three signers from three addresses. Remember, you only need three signatures to approve a transaction in the safe:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ceo_signer = provider.getSigner(ceo);</span><br><span class="line"><span class="keyword">const</span> cto_signer = provider.getSigner(cto);</span><br><span class="line"><span class="keyword">const</span> advisor_signer = provider.getSigner(advisor);</span><br></pre></td></tr></table></figure>

<p>The Gnosis Safe smart contracts work with the <code>ethers.js</code> library and the <code>web3.js</code> library. In this tutorial, you are using <code>ethers.js</code>. So you need the adapter that works with <code>ethers.js</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> EthersAdapter = <span class="built_in">require</span>(<span class="string">&#x27;@gnosis.pm/safe-ethers-lib&#x27;</span>)[<span class="string">&quot;default&quot;</span>];</span><br><span class="line"><span class="keyword">const</span> ethAdapter_ceo = <span class="keyword">new</span> EthersAdapter(&#123; ethers, <span class="attr">signer</span>: ceo_signer &#125;);</span><br><span class="line"><span class="keyword">const</span> ethAdapter_cto = <span class="keyword">new</span> EthersAdapter(&#123; ethers, <span class="attr">signer</span>: cto_signer &#125;);</span><br><span class="line"><span class="keyword">const</span> ethAdapter_advisor = <span class="keyword">new</span> EthersAdapter(&#123; ethers, <span class="attr">signer</span>: advisor_signer &#125;);</span><br></pre></td></tr></table></figure>

<p>In the code above, you interacted with the Gnosis Safe SDK using these adapters. Note that each address needs its own adapter.</p>
<p>Next, create the <code>main</code>, asynchronous function. You will use <a target="_blank" rel="noopener" href="https://hardhat.org/getting-started/#deploying-your-contracts">this pattern to handle</a> <code>async/await</code> and handle errors in the code properly:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// FROM NOW ON, YOUR CODE IS PUT HERE</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main()</span><br><span class="line">  .then(<span class="function">() =&gt;</span> process.exit(<span class="number">0</span>))</span><br><span class="line">  .catch(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(error);</span><br><span class="line">    process.exit(<span class="number">1</span>);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>As explained in the beginning of the tutorial, the only way to create a safe is from the safe factory that is shared with everyone. So first, you need to create a safe factory object connecting to the safe factory smart contract, <code>GnosisSafeProxyFactory</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> id = <span class="keyword">await</span> ethAdapter_ceo.getChainId();</span><br><span class="line"><span class="keyword">const</span> contractNetworks = &#123;</span><br><span class="line">  [id]: &#123;</span><br><span class="line">    multiSendAddress: process.env.MULTI_SEND_ADDRESS,</span><br><span class="line">    safeMasterCopyAddress: process.env.SAFE_MASTER_COPY_ADDRESS,</span><br><span class="line">    safeProxyFactoryAddress: process.env.SAFE_PROXY_FACTORY_ADDRESS</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> safeFactory = <span class="keyword">await</span> SafeFactory.create(&#123; <span class="attr">ethAdapter</span>: ethAdapter_ceo, <span class="attr">contractNetworks</span>: contractNetworks &#125;);</span><br></pre></td></tr></table></figure>

<p>In the code above, you first received the chain ID. Then, you created an object containing three smart contracts with which you safe will interact. Finally, you created a safe factory.</p>
<p>Next, create a safe from this safe factory like so:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> owners = [ceo, cto, meme_artist, solidity_engineer, advisor];</span><br><span class="line"><span class="keyword">const</span> threshold = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">const</span> safeAccountConfig = &#123; <span class="attr">owners</span>: owners, <span class="attr">threshold</span>: threshold&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> safeSdk_ceo = <span class="keyword">await</span> safeFactory.deploySafe(&#123;safeAccountConfig&#125;);</span><br></pre></td></tr></table></figure>

<p>The safe needs the addresses of the members and the minimum amount of signatures required to approve transactions for this safe. In the code above, you put all members of the startup and <code>3</code> as the threshold. To deploy a safe, you can use the <code>deploySafe</code> method from the safe factory.</p>
<p>Now that you have a safe already, an investor sends money to your startup, which would look like this:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> treasury = safeSdk_ceo.getAddress();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ten_ethers = ethers.utils.parseUnits(<span class="string">&quot;10&quot;</span>, <span class="string">&#x27;ether&#x27;</span>).toHexString();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> params = [&#123;</span><br><span class="line">      <span class="keyword">from</span>: investor,</span><br><span class="line">      to: treasury,</span><br><span class="line">      value: ten_ethers</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> provider.send(<span class="string">&quot;eth_sendTransaction&quot;</span>, params);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;Fundraising.&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>The safe holds your treasury. The investor sent 10ETH using the <code>eth_sendTransaction</code> RPC method.</p>
<p>To make sure it works, you can check the balance of the treasury with the following:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> balance = <span class="keyword">await</span> safeSdk_ceo.getBalance();</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`Initial balance of the treasury: <span class="subst">$&#123;ethers.utils.formatUnits(balance, <span class="string">&quot;ether&quot;</span>)&#125;</span> ETH`</span>);</span><br></pre></td></tr></table></figure>

<h2 id="Obtaining-multisignature-approval"><a href="#Obtaining-multisignature-approval" class="headerlink" title="Obtaining multisignature approval"></a>Obtaining multisignature approval</h2><p>Once the investor’s money is in, you can move fast. Create a transaction to buy a yacht like so:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> three_ethers = ethers.utils.parseUnits(<span class="string">&quot;3&quot;</span>, <span class="string">&#x27;ether&#x27;</span>).toHexString();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> transaction = &#123;</span><br><span class="line">  to: yacht_shop,</span><br><span class="line">  data: <span class="string">&#x27;0x&#x27;</span>,</span><br><span class="line">  value: three_ethers</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> safeTransaction = <span class="keyword">await</span> safeSdk_ceo.createTransaction(transaction);</span><br><span class="line"><span class="keyword">const</span> hash = <span class="keyword">await</span> safeSdk_ceo.getTransactionHash(safeTransaction);</span><br></pre></td></tr></table></figure>

<p>The transaction is sending 3ETH to the yacht shop. Since the transaction is transferring ETH, you can fill empty data, <code>0x</code>, in the data field of the transaction. However, if you create a smart contract transaction, such as minting NFTs or selling tokens, you will need to fill the data field.</p>
<p>After doing that, create the safe transaction using the <code>createTransaction</code> method. Then, get the hash with the <code>getTransactionHash</code> method.</p>
<p>Finally, your job as CEO is to approve the transaction:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> txResponse = <span class="keyword">await</span> safeSdk_ceo.approveTransactionHash(hash);</span><br><span class="line"><span class="keyword">await</span> txResponse.transactionResponse?.wait();</span><br></pre></td></tr></table></figure>

<p>But your job is not done yet. You call your co-founder, the CTO of your startup, and persuade her to approve the transaction of buying a yacht. “Wouldn’t it be nice if you could code in the vast ocean?”</p>
<p>Your CTO agrees to approve the transaction:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> safeSdk_cto = <span class="keyword">await</span> Safe.create(&#123; <span class="attr">ethAdapter</span>: ethAdapter_cto,</span><br><span class="line">                                        safeAddress: treasury,</span><br><span class="line">                                        contractNetworks: contractNetworks &#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> safeTransactionCTO = <span class="keyword">await</span> safeSdk_cto.createTransaction(transaction);</span><br><span class="line"><span class="keyword">const</span> hashCTO = <span class="keyword">await</span> safeSdk_ceo.getTransactionHash(safeTransaction);</span><br><span class="line"><span class="keyword">const</span> txResponse_cto = <span class="keyword">await</span> safeSdk_cto.approveTransactionHash(hashCTO);</span><br><span class="line"><span class="keyword">await</span> txResponse_cto.transactionResponse?.wait();</span><br></pre></td></tr></table></figure>

<p>The CTO needs a different Safe object. But you don’t need to create it with the safe factory; you can create it with the <code>create</code> method of the Safe object. Because your safe smart contract is live already on the blockchain, you just passed the treasury address when you created the Safe object.</p>
<p>Next, you pass the transaction to your CTO either by chatting or via email. What the transaction means in this context is the <code>transaction</code> object in the code. Remember, you’ve already created this object:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> transaction = &#123;</span><br><span class="line">  to: yacht_shop,</span><br><span class="line">  data: <span class="string">&#x27;0x&#x27;</span>,</span><br><span class="line">  value: three_ethers</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>Your CTO created a safe transaction from this one and got its hash. Then, she approves the transaction using the <code>approveTransactionHash</code> method, which accepts the hash argument.</p>
<p>Your job is still not done yet; you need another signature. But this time, you don’t need to convince your advisor because he gives you full support to buy a yacht. He approves the transaction:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> safeSdk_advisor = <span class="keyword">await</span> Safe.create(&#123; <span class="attr">ethAdapter</span>: ethAdapter_advisor,</span><br><span class="line">                                            safeAddress: treasury,</span><br><span class="line">                                            contractNetworks: contractNetworks &#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> safeTransactionAdvisor = <span class="keyword">await</span> safeSdk_advisor.createTransaction(transaction);</span><br><span class="line"><span class="keyword">const</span> txResponse_advisor = <span class="keyword">await</span> safeSdk_advisor.executeTransaction(safeTransactionAdvisor);</span><br><span class="line"><span class="keyword">await</span> txResponse_advisor.transactionResponse?.wait();</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;Buying a yacht.&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>The code is the same as the CTO’s approval transaction, but instead of the <code>approveTransactionHash</code> method, the advisor used the <code>executeTransaction</code> method. This method approves the transaction as well behind the scenes. But most importantly, this method executes the safe transaction, which is buying a yacht!</p>
<p>Finally, let’s check your treasury balance:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> afterBalance = <span class="keyword">await</span> safeSdk_ceo.getBalance();</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`The final balance of the treasury: <span class="subst">$&#123;ethers.utils.formatUnits(afterBalance, <span class="string">&quot;ether&quot;</span>)&#125;</span> ETH`</span>);</span><br></pre></td></tr></table></figure>

<p>The script is finished. You can execute the script like so:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> node index.js</span></span><br><span class="line">Fundraising.</span><br><span class="line">Initial balance of the treasury: 10.0 ETH</span><br><span class="line">Buying a yacht.</span><br><span class="line">The final balance of the treasury: 7.0 ETH</span><br></pre></td></tr></table></figure>

<p>Now, you can work in a yacht with your team building a DAO to disrupt banks!</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>In this article, you learned how to create a Gnosis Safe that can be configured to require multiple signatures to approve transactions. You launched the Gnosis Safe smart contracts in the Hardhat development network, then, using the Gnosis safe SDK, created a safe to hold the treasury. Using multiple addresses, you created and approved the transaction of sending ETH.</p>
<p>This article only explains the SDK of interacting with the Gnosis Safe smart contracts. If you want to learn the ins and outs of the smart contract themselves, you can check <a target="_blank" rel="noopener" href="https://github.com/gnosis/safe-contracts/">their GitHub repository</a>! The SDK also has other methods like signing a transaction off-chain. Check <a target="_blank" rel="noopener" href="https://github.com/gnosis/safe-core-sdk/tree/main/packages/safe-core-sdk">their GitHub repository</a> to learn more. The code for this article is available on <a target="_blank" rel="noopener" href="https://github.com/arjunaskykok/gnosis-safe-web3-startup">this GitHub repository</a>.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://willzhuang.github.io/2022/03/31/%E4%BD%93%E9%AA%8Cfirefly/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Weiming Zhuang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhuang's Diary">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/31/%E4%BD%93%E9%AA%8Cfirefly/" class="post-title-link" itemprop="url">体验firefly</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-31 20:15:00" itemprop="dateCreated datePublished" datetime="2022-03-31T20:15:00+08:00">2022-03-31</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2022-04-01 22:50:03" itemprop="dateModified" datetime="2022-04-01T22:50:03+08:00">2022-04-01</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>firefly is a very interesting project ==&gt; <a target="_blank" rel="noopener" href="https://hyperledger.github.io/firefly/">https://hyperledger.github.io/firefly/</a> </p>
<p>To help with the FireFly evaluation, especially how it makes digital assets management easy by supporting token standards (ERC20, ERC721, ERC1155, and other standard contracts or your custom implementations via extensions) with REST APIs and event streams, we have a minimal tutorial that you can set up locally on your laptop. Please give it a try and let us know if you have any questions.</p>
<ol>
<li>install the latest FireFly CLI:</li>
</ol>
<p>$ go install <a target="_blank" rel="noopener" href="https://urldefense.com/v3/__http:/github.com/hyperledger/firefly-cli/ff@latest__;!!LSAcJDlP!hkQGL7MWpqV_y1r5RSaiFUgGNz3QpZ8L09BtbpQtqCn9e1jOOHhtfO9Jf5tIZlpZUVgtKg$">github.com/hyperledger/firefly-cli/ff@latest</a></p>
<ol start="2">
<li>initialize the FireFly stack using Ethereum as the underlying blockchain, and load the ERC20/ERC721 token connector:</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ff init -t erc20_erc721</span><br></pre></td></tr></table></figure>



<ol start="3">
<li>start the stack named “digital-assets”</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ff start digital-assets</span><br></pre></td></tr></table></figure>



<ol start="4">
<li>deploy the token contract. the easiest way is using Truffle. The Hyperledger implementation of the token connector has sample ERC20 and ERC721 contracts you can use to deploy to Ethereum:</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> [git@github.com:hyperledger/firefly-tokens-erc20-erc721.git](mailto:git@github.com:hyperledger/firefly-tokens-erc20-erc721.git)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> firefly-tokens-erc20-erc721</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> solidity</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> npm install</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> truffle migrate</span></span><br></pre></td></tr></table></figure>



<ol start="5">
<li>copy the contract address for the deployed ERC20 token contract (highlighted below in the sample output), to use in the next step</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">Starting migrations...</span><br><span class="line"></span><br><span class="line"> \&gt; Network name:   &#x27;development&#x27;</span><br><span class="line"> \&gt; Network id:    2021</span><br><span class="line"> \&gt; Block gas limit: 4722986 (0x48112a)</span><br><span class="line"></span><br><span class="line"> 1_initial_migration.js</span><br><span class="line"></span><br><span class="line">   Deploying &#x27;Migrations&#x27;</span><br><span class="line">   \----------------------</span><br><span class="line">   ⠋ Blocks: 0       Seconds: 0  &gt; transaction hash:   0xb81c60fd920bf28775bd8610271c60a40380e278af97ccd18458efafe852dc99</span><br><span class="line">   \&gt; Blocks: 0       Seconds: 0</span><br><span class="line">   \&gt; contract address:   0x0C2c9222835692912b3999D6DAE955a9d306393d</span><br><span class="line">   \&gt; block number:     6</span><br><span class="line">   \&gt; block timestamp:   1648585628</span><br><span class="line">   \&gt; account:       0x1eAecAb9D796Ee765865f47a78De13735619c914</span><br><span class="line">   \&gt; balance:       904625697166532776746648320380374280103671755200316906558.262375061821325312</span><br><span class="line">   \&gt; gas used:       272788 (0x42994)</span><br><span class="line">   \&gt; gas price:      0 gwei</span><br><span class="line">   \&gt; value sent:      0 ETH</span><br><span class="line">   \&gt; total cost:      0 ETH</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   \&gt; Saving migration to chain.</span><br><span class="line">   \&gt; Saving artifacts</span><br><span class="line">   \-------------------------------------</span><br><span class="line">   \&gt; Total cost:          0 ETH</span><br><span class="line"></span><br><span class="line"> 2_deploy_contracts.js</span><br><span class="line"></span><br><span class="line">   Deploying &#x27;ERC20WithData&#x27;</span><br><span class="line">   \-------------------------</span><br><span class="line">   ⠋ Blocks: 0       Seconds: 0  &gt; transaction hash:   0x748a60953ceacda47431210752c2a9991f77b552d19397827500feef086fc3cf</span><br><span class="line">   \&gt; Blocks: 0       Seconds: 0</span><br><span class="line">   \&gt; contract address:   **0xB6728020f998f32afb4936f9CEcE04B1d3951895**</span><br><span class="line">   \&gt; block number:     8</span><br><span class="line">   \&gt; block timestamp:   1648585628</span><br><span class="line">   \&gt; account:       0x1eAecAb9D796Ee765865f47a78De13735619c914</span><br><span class="line">   \&gt; balance:       904625697166532776746648320380374280103671755200316906558.262375061821325312</span><br><span class="line">   \&gt; gas used:       1948804 (0x1dbc84)</span><br><span class="line">   \&gt; gas price:      0 gwei</span><br><span class="line">   \&gt; value sent:      0 ETH</span><br><span class="line">   \&gt; total cost:      0 ETH</span><br><span class="line"></span><br><span class="line">   \&gt; Saving migration to chain.</span><br><span class="line">   \&gt; Saving artifacts</span><br><span class="line">   \-------------------------------------</span><br><span class="line">   \&gt; Total cost:          0 ETH</span><br></pre></td></tr></table></figure>



<h1 id="Summary"><a href="#Summary" class="headerlink" title=" Summary"></a> Summary</h1><p> &gt; Total deployments:  2<br> &gt; Final cost:      0 ETH</p>
<ol start="6">
<li>teach FireFly about the token contract so that it can start tracking transactions on the contract. For this step you can use the Swagger UI that comes with FireFly. Open <a target="_blank" rel="noopener" href="https://urldefense.com/v3/__http:/localhost:5000/api__;!!LSAcJDlP!hkQGL7MWpqV_y1r5RSaiFUgGNz3QpZ8L09BtbpQtqCn9e1jOOHhtfO9Jf5tIZlpI4RuZkA$">http://localhost:5000/api</a>, and expand the request entry POST /namespaces/{ns}/tokens/pools. Plugin the values as shown below (you can delete all the other optional properties in the payload): </li>
</ol>
<p><img src="/2022/03/31/%E4%BD%93%E9%AA%8Cfirefly/1.png"></p>
<ol start="7">
<li>Now you can start using FireFly APIs to manage the new token contract: mint/transfer/burn.</li>
</ol>
<ol start="8">
<li>You can use the following JSON RPC command to create additional Ethereum addresses in the go-ethereum node’s built-in wallet:</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d <span class="string">&#x27;&#123;&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:&quot;1&quot;,&quot;method&quot;:&quot;personal_newAccount&quot;,&quot;params&quot;:[&quot;**passw0rd**&quot;]&#125;&#x27;</span> [http://localhost:5100](https://urldefense.com/v3/__http:/localhost:5100__;!!LSAcJDlP!hkQGL7MWpqV_y1r5RSaiFUgGNz3QpZ8L09BtbpQtqCn9e1jOOHhtfO9Jf5tIZlpXnXqo_Q$) | jq</span></span><br><span class="line"> &#123;</span><br><span class="line">  &quot;jsonrpc&quot;: &quot;2.0&quot;,</span><br><span class="line">  &quot;id&quot;: &quot;1&quot;,</span><br><span class="line">  &quot;result&quot;: &quot;**0xfd5d5d96879a700c693da5092e2a6ef5ed399684**&quot;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d <span class="string">&#x27;&#123;&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:&quot;1&quot;,&quot;method&quot;:&quot;personal_unlockAccount&quot;,&quot;params&quot;:[&quot;**0xfd5d5d96879a700c693da5092e2a6ef5ed399684**&quot;,&quot;**passw0rd**&quot;,0]&#125;&#x27;</span>  [http://localhost:5100](https://urldefense.com/v3/__http:/localhost:5100__;!!LSAcJDlP!hkQGL7MWpqV_y1r5RSaiFUgGNz3QpZ8L09BtbpQtqCn9e1jOOHhtfO9Jf5tIZlpXnXqo_Q$) |jq</span></span><br><span class="line"> &#123;</span><br><span class="line">  &quot;jsonrpc&quot;: &quot;2.0&quot;,</span><br><span class="line">  &quot;id&quot;: &quot;1&quot;,</span><br><span class="line">  &quot;result&quot;: true</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>



<ol start="9">
<li>Try the minting API using the POST /namespaces/{ns}/tokens/mint endpoint: </li>
</ol>
<p><img src="/2022/03/31/%E4%BD%93%E9%AA%8Cfirefly/2.png"></p>
<ol start="10">
<li>check the result of the minting transaction in the FireFly UI at <a target="_blank" rel="noopener" href="https://urldefense.com/v3/__http:/localhost:5000/ui__;!!LSAcJDlP!hkQGL7MWpqV_y1r5RSaiFUgGNz3QpZ8L09BtbpQtqCn9e1jOOHhtfO9Jf5tIZloTMvxMnw$">http://localhost:5000/ui</a> (for org0) and http//localhost:5001/ui (for org1): </li>
</ol>
<p><img src="/2022/03/31/%E4%BD%93%E9%AA%8Cfirefly/3.png"></p>
<p>That’s it! Now you have a local setup to explore the many features of FireFly.</p>
<ol start="11">
<li>connect with metamask as below. by the way, the para when you add a network for firefly , please refer the info at <code>~/.firefly/stacks/oh/blockchain/genesis.json</code>, here you can cat genesis block info.</li>
</ol>
<p><img src="/2022/03/31/%E4%BD%93%E9%AA%8Cfirefly/4.png"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://willzhuang.github.io/2022/03/11/CS251_Final_Exam_2021-stanford.edu-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Weiming Zhuang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhuang's Diary">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/11/CS251_Final_Exam_2021-stanford.edu-1/" class="post-title-link" itemprop="url">CS251_Final_Exam_2021-stanford.edu-2</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-11 18:54:00" itemprop="dateCreated datePublished" datetime="2022-03-11T18:54:00+08:00">2022-03-11</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2022-03-31 20:17:13" itemprop="dateModified" datetime="2022-03-31T20:17:13+08:00">2022-03-31</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="Problem-2-20-points-Byzantine-broadcast"><a href="#Problem-2-20-points-Byzantine-broadcast" class="headerlink" title="Problem 2. [20 points]: Byzantine broadcast."></a>Problem 2. [20 points]: Byzantine broadcast.</h4><p>Consider n parties, where n ≥ 3, and where one of the parties is designated as a sender. The sender has a bit b ∈ {0, 1}. A broadcast protocol is a protocol where the parties send messages to one another, and eventually every party outputs a bit bi , for i = 1, . . . , n, or outputs nothing. </p>
<ul>
<li><p>We say that the protocol has consistency if for every two honest parties, if one party outputs b and the other outputs b’ , then b = b’ . </p>
</li>
<li><p>We say that the protocol has validity if when the sender is honest, the output of all honest parties is equal to the sender’s input bit b. </p>
</li>
<li><p>We say that the protocol has totality if whenever some honest party outputs a bit, then eventually all honest parties output a bit. </p>
</li>
</ul>
<p>A reliable broadcast protocol (RBC) is a broadcast protocol that satisfies all three properties. Let us assume that there is a public key infrastructure (PKI), meaning that every party has a secret signing key, and every party knows the correct public signature verification key for every other party. </p>
<p>In a synchronous network, consider the following broadcast protocol: </p>
<ul>
<li><p>step 0: The sender sends its input bit b (along with its signature) to all other parties. The sender then outputs its bit b and terminates. </p>
</li>
<li><p>step 1: Every non-sender party i echoes what it heard from the sender to all the other non-sender parties (with i’s signature added). If the party heard nothing from the sender, it does nothing in this step. Similarly, the party does nothing in this step if the sender’s message is malformed: for example, if the sender’s signature is invalid, or the message is not a single bit. </p>
</li>
<li><p>step 2: Every non-sender party collects all the messages it received (up to n−1 messages, with at most one from the sender in step 0 and at most one from each non-sender party in step 1). If some two of the received messages contain a valid signature by the sender, but for opposite bits (i.e., in one signed message the bit is 0 and in the other signed message the bit is 1) then the sender is dishonest and the party outputs 0 and terminates. Otherwise, all the properly signed bits from the sender are the same, and the party outputs that bit. If the non-sender received no messages, it outputs nothing. </p>
</li>
</ul>
<p>For each of the following questions, describe an attack or explain why there is no attack. </p>
<p><strong>A) If there is at most one dishonest party, does the protocol have consistency?</strong></p>
<p>answer - a dishonest party have options as below in step 1 &amp; 2 to cheat a honest part:</p>
<ol>
<li><p>don’t answer / response;</p>
</li>
<li><p>broke sender’s signature but cannot make a fake/wrong bit b, because broken signature cannot verify correct.</p>
</li>
<li><p>broke node’s signature itself. </p>
</li>
</ol>
<p>If the sender is a dishonest party, in step 0, dishonest part can send b to some parties, and send a different b’ to other parties. Then it <strong>don’t have consistency</strong>. If the sender is a honest part, the dishonest party don’t  response, so other nodes can’t accumulate “all the properly signed bits from the sender are the same, and the party outputs that bit”, then other nodes have no response. Then it still <strong>don’t have consistency</strong>.</p>
<p><strong>B) If there is at most one dishonest party, does the protocol have validity?</strong></p>
<p>answer - dishonest party don’t response any message , and make other nodes cannot reach “all the properly signed bits from the sender are the same, and the party outputs that bit.”  So this protocol don’t have validity.</p>
<p><strong>C) If there are at most two dishonest parties, show that the protocol does not have consistency.</strong></p>
<p>answer - As answer A)</p>
<p><strong>D) If there are at most two dishonest parties, does the protocol have validity?</strong></p>
<p>answer - two dishonest parties can send out the same dishonest message or they don’t response, and make other nodes cannot reach “all the properly signed bits from the sender are the same, and the party outputs that bit.”  So this protocol don’t have validity.  </p>
<p><strong>E) Does the protocol have totality (for any number of dishonest parties)?</strong></p>
<p>answer - It assume that this protocol run in a reliable broadcast protocol (RBC). But the dishonest party can send a (or some) correct response to one (or some other) party, but don’t response any message to one (or some other) party in step 1. Dishonest party also can do the same in step 0. So these honest party cannot have the same result. Then this protocol don’t have totality.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/37/">37</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>


<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Weiming Zhuang</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  
<script src="/js/local-search.js"></script>






  




  <script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'none'
      },
      options: {
        renderActions: {
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              const target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js';
    script.defer = true;
    document.head.appendChild(script);
  } else {
    MathJax.startup.document.state(0);
    MathJax.typesetClear();
    MathJax.texReset();
    MathJax.typeset();
  }
</script>




</body>
</html>
